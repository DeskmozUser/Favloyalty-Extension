<script>
  function wd() {
    var t = document.createElement('iframe');
    // let url='https://shopify.favseo.com/fav_loyalty/widget'
    let url = 'https://shopify.favseo.com';

    t.setAttribute('style', 'position: fixed; bottom: 10px; right: 0; width: 420px; height: 700px; border: none;'),
      t.setAttribute('src', `${url}?shop={{ shop.url | url_encode }}`),
      t.setAttribute('allow', 'clipboard-write');
      // t.setAttribute('src', 'http://localhost:3000'),
      // https://light-berries-yell.loca.lt/
      document.body.appendChild(t);
  }

  wd();
</script>

<script>
  window.addEventListener('message', (event) => {
    if (event.origin === 'https://shopify.favseo.com') {
      if (event.data.type === 'REQUEST_LOCAL_STORAGE') {
        const localStorageData = JSON.stringify(localStorage);
        event.source.postMessage({ type: 'LOCAL_STORAGE_DATA', payload: localStorageData }, event.origin);
      }
      else if (event.data.type === 'SET_LOCAL_STORAGE') {
        const { key, value } = event.data.payload;
        // console.log(key, value)
        localStorage.setItem(key, value);
      }
      else if (event.data.type === "REQUEST_FAVLOYALTY_DATA") {

      let customer_data = null
        {% if customer != nil %}
        customer_data = {
          id:{{ customer.id }},
          email: '{{- customer.email -}}',
          first_name: '{{- customer.first_name -}}',
          last_name: '{{- customer.last_name -}}',
          shop: '{{- shop.secure_url -}}',
          accepts_marketing: {{ customer.accepts_marketing }},
          orders_count: {{ customer.orders_count }},
          total_spent: {{ customer.total_spent }},

    },

    {% endif %}
        event.source.postMessage({ type: 'REQUEST_FAVLOYALTY_DATA', payload: { shop: '{{- shop.secure_url -}}',customer:customer_data} }, event.origin);
      }
      else if (event.data.type === "REQUEST_CUSTOMER_DATA") {
        let customer_data = null
        {% if customer != nil %}
        customer_data = {
          id:{{ customer.id }},
          email: '{{- customer.email -}}',
          first_name: '{{- customer.first_name -}}',
          last_name: '{{- customer.last_name -}}',
          shop: '{{- shop.secure_url -}}',
          accepts_marketing: {{ customer.accepts_marketing }},
          orders_count: {{ customer.orders_count }},
          total_spent: {{ customer.total_spent }},

    },



    {% endif %}

    event.source.postMessage({
      type: "REQUEST_CUSTOMER_DATA", payload: customer_data
    }, event.origin)
  }
  }
  });
</script>

<script>
  let loginWebhook = false;
  {% if customer != nil %}
  if (!window.localStorage.getItem('logged')) {
    loginWebhook = true;
  }
  {% else %}
  window.localStorage.removeItem('logged')
  {% endif %}
</script>

<script>
  if (loginWebhook) {
    window.localStorage.setItem('logged', JSON.stringify({ logged: true, customer: null }));
    console.log('CALL endpoint of webhook', '{{- customer.email -}}');
    // Make a fetch request here and call the webhook endpoint
    // Manually call webhook
    //  let backendurl='https://shopify.favseo.com/fav_loyalty/loyalty_node'
    var backendurl = 'http://localhost:4000';

    const webhookURL = `${backendurl}/api/revalidate/login`;
    const webhookData = {
      email: '{{- customer.email -}}',
      first_name: '{{- customer.first_name -}}',
      last_name: '{{- customer.last_name -}}',
      shop: '{{- shop.secure_url -}}',
    };
    fetch(webhookURL, {
      method: 'POST', // *GET, POST, PUT, DELETE, etc.
      headers: {
        'Content-Type': 'application/json',
      },
      body: JSON.stringify(webhookData),
    });
  }
</script>

{% schema %}
{
  "name": "Favloyalty",
  "target": "body",
  "settings": [
    { "type": "product", "id": "product", "label": "product", "autofill": true },
    { "type": "color", "id": "colour", "label": "Star Colour", "default": "#ff0000" }
  ]
}
{% endschema %}
